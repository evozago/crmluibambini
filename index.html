<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Lui Bambini</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .sidebar {
            background-color: #343a40;
            color: white;
            height: 100vh;
            position: fixed;
            padding-top: 20px;
        }
        .sidebar a {
            color: #adb5bd;
            text-decoration: none;
            padding: 10px 15px;
            display: block;
            transition: all 0.3s;
        }
        .sidebar a:hover, .sidebar a.active {
            color: white;
            background-color: #495057;
        }
        .sidebar .nav-icon {
            margin-right: 10px;
        }
        .content {
            margin-left: 250px;
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        .stats-card {
            text-align: center;
            padding: 20px;
        }
        .stats-card h3 {
            margin-bottom: 0;
        }
        .stats-card p {
            color: #6c757d;
        }
        .chart-container {
            height: 300px;
        }
        .table-container {
            overflow-x: auto;
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover, .upload-area.active {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            position: relative;
        }
        .step.active {
            font-weight: bold;
            color: #007bff;
        }
        .step:not(:last-child):after {
            content: '';
            position: absolute;
            top: 50%;
            right: 0;
            width: 100%;
            height: 2px;
            background-color: #e9ecef;
            z-index: -1;
        }
        .badge.bg-success {
            background-color: #28a745 !important;
        }
        .badge.bg-primary {
            background-color: #20c997 !important;
        }
        .badge.bg-warning {
            background-color: #ffc107 !important;
        }
        .badge.bg-danger {
            background-color: #dc3545 !important;
        }
        .badge.bg-secondary {
            background-color: #6c757d !important;
        }
        .badge.bg-dark {
            background-color: #343a40 !important;
        }
        .progress {
            height: 25px;
        }
        .progress-bar {
            line-height: 25px;
            font-size: 14px;
        }
        #processing-log {
            height: 200px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
        }
        .log-info {
            color: #0d6efd;
        }
        .log-success {
            color: #198754;
        }
        .log-warning {
            color: #ffc107;
        }
        .log-error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar">
                <h3 class="text-center mb-4">CRM Lui Bambini</h3>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a href="#dashboard" class="nav-link active" onclick="showPage('dashboard')">
                            <span class="nav-icon">üìä</span> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#clientes" class="nav-link" onclick="showPage('clientes')">
                            <span class="nav-icon">üë•</span> Clientes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#mensagens" class="nav-link" onclick="showPage('mensagens')">
                            <span class="nav-icon">üí¨</span> Mensagens
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#estatisticas" class="nav-link" onclick="showPage('estatisticas')">
                            <span class="nav-icon">üìà</span> Estat√≠sticas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#importacao" class="nav-link" onclick="showPage('importacao')">
                            <span class="nav-icon">üì•</span> Importa√ß√£o
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Content -->
            <div class="col-md-10 content">
                <!-- Dashboard Page -->
                <div id="dashboard" class="page">
                    <h2 class="mb-4">Dashboard</h2>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card stats-card">
                                <h3 id="clientes-ativos">0</h3>
                                <p>Clientes Ativos</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stats-card">
                                <h3 id="clientes-inativos">0</h3>
                                <p>Clientes Inativos</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stats-card">
                                <h3 id="clientes-risco">0</h3>
                                <p>Clientes em Risco</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stats-card">
                                <h3 id="dias-medios">0</h3>
                                <p>Dias M√©dios de Inatividade</p>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Distribui√ß√£o de Clientes por Tempo de Inatividade</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="inactivityChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Clientes que Precisam de Aten√ß√£o</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-container">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Nome</th>
                                                    <th>√öltima Compra</th>
                                                    <th>Dias Inativos</th>
                                                    <th>A√ß√£o</th>
                                                </tr>
                                            </thead>
                                            <tbody id="clientes-atencao">
                                                <tr>
                                                    <td colspan="4" class="text-center">Nenhum dado dispon√≠vel</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clientes Page -->
                <div id="clientes" class="page" style="display: none;">
                    <h2 class="mb-4">Clientes</h2>
                    <div class="card">
                        <div class="card-header">
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="busca-cliente" placeholder="Buscar cliente...">
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="filtro-categoria">
                                        <option value="todos">Todos os clientes</option>
                                        <option value="0-30">Ativos (√∫ltimos 30 dias)</option>
                                        <option value="31-60">Ativos (31-60 dias)</option>
                                        <option value="61-90">Em risco (61-90 dias)</option>
                                        <option value="91-180">Em risco elevado (91-180 dias)</option>
                                        <option value="181-365">Inativos (181-365 dias)</option>
                                        <option value="365+">Perdidos (mais de 365 dias)</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary w-100" id="btn-filtrar">Filtrar</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>CPF</th>
                                            <th>Telefone</th>
                                            <th>√öltima Compra</th>
                                            <th>Dias Inativos</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-clientes">
                                        <tr>
                                            <td colspan="7" class="text-center">Nenhum dado dispon√≠vel</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <nav>
                                <ul class="pagination justify-content-center" id="paginacao">
                                    <li class="page-item disabled"><a class="page-link" href="#">Anterior</a></li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item disabled"><a class="page-link" href="#">Pr√≥ximo</a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Mensagens Page -->
                <div id="mensagens" class="page" style="display: none;">
                    <h2 class="mb-4">Mensagens Personalizadas</h2>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Clientes Ativos (√∫ltimos 30 dias)</h5>
                                </div>
                                <div class="card-body">
                                    <p>Ol√° <strong class="nome-cliente">Cliente</strong>, tudo bem? Passando para agradecer pela sua compra recente em nossa loja. Esperamos que esteja satisfeito(a) com os produtos. Estamos √† disposi√ß√£o para o que precisar!</p>
                                    <button class="btn btn-primary btn-copiar" data-categoria="0-30">Copiar Mensagem</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Clientes Ativos (31-60 dias)</h5>
                                </div>
                                <div class="card-body">
                                    <p>Ol√° <strong class="nome-cliente">Cliente</strong>! J√° faz <strong class="dias-inativo">45</strong> dias desde sua √∫ltima visita √† Lui Bambini. Estamos com novidades que podem te interessar! Quando puder, d√™ uma passadinha em nossa loja. Ser√° um prazer atend√™-lo(a) novamente!</p>
                                    <button class="btn btn-primary btn-copiar" data-categoria="31-60">Copiar Mensagem</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Clientes em Risco (61-90 dias)</h5>
                                </div>
                                <div class="card-body">
                                    <p>Ol√° <strong class="nome-cliente">Cliente</strong>! Sentimos sua falta! J√° faz <strong class="dias-inativo">75</strong> dias desde sua √∫ltima compra conosco. Estamos com produtos novos que combinam com seu estilo. Que tal passar na Lui Bambini esta semana? Temos condi√ß√µes especiais para voc√™!</p>
                                    <button class="btn btn-primary btn-copiar" data-categoria="61-90">Copiar Mensagem</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Clientes em Risco Elevado (91-180 dias)</h5>
                                </div>
                                <div class="card-body">
                                    <p>Ol√° <strong class="nome-cliente">Cliente</strong>! Estamos com saudades! Faz <strong class="dias-inativo">135</strong> dias que n√£o o(a) vemos em nossa loja. Preparamos uma surpresa especial para seu retorno: 10% de desconto na pr√≥xima compra! Venha conferir as novidades da Lui Bambini!</p>
                                    <button class="btn btn-primary btn-copiar" data-categoria="91-180">Copiar Mensagem</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Inativos (181-365 dias)</h5>
                                </div>
                                <div class="card-body">
                                    <p>Ol√° <strong class="nome-cliente">Cliente</strong>! H√° quanto tempo! Faz mais de <strong class="dias-inativo">270</strong> dias que voc√™ n√£o nos visita. Gostar√≠amos de saber se est√° tudo bem e se podemos fazer algo para t√™-lo(a) de volta. Temos um presente exclusivo para voc√™ na sua pr√≥xima compra!</p>
                                    <button class="btn btn-primary btn-copiar" data-categoria="181-365">Copiar Mensagem</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Perdidos (mais de 365 dias)</h5>
                                </div>
                                <div class="card-body">
                                    <p>Ol√° <strong class="nome-cliente">Cliente</strong>. Sentimos muito a sua falta. Gostar√≠amos de entender o motivo do seu afastamento e reconquistar sua confian√ßa. Por favor, entre em contato conosco. A Lui Bambini valoriza muito sua prefer√™ncia.</p>
                                    <button class="btn btn-primary btn-copiar" data-categoria="365+">Copiar Mensagem</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estat√≠sticas Page -->
                <div id="estatisticas" class="page" style="display: none;">
                    <h2 class="mb-4">Estat√≠sticas Detalhadas</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Distribui√ß√£o Percentual de Clientes</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="percentageChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Tend√™ncia de Inatividade</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="trendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Resumo por Categoria</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-container">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Categoria</th>
                                                    <th>Quantidade</th>
                                                    <th>Porcentagem</th>
                                                    <th>Dias M√©dios</th>
                                                    <th>A√ß√£o Recomendada</th>
                                                </tr>
                                            </thead>
                                            <tbody id="resumo-categorias">
                                                <tr>
                                                    <td colspan="5" class="text-center">Nenhum dado dispon√≠vel</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Importa√ß√£o Page -->
                <div id="importacao" class="page" style="display: none;">
                    <h2 class="mb-4">Importa√ß√£o de Planilhas</h2>
                    <div class="card">
                        <div class="card-body">
                            <div class="step-indicator">
                                <div class="step active" id="step-upload">Upload</div>
                                <div class="step" id="step-mapeamento">Mapeamento</div>
                                <div class="step" id="step-processamento">Processamento</div>
                                <div class="step" id="step-conclusao">Conclus√£o</div>
                            </div>
                            
                            <!-- Step 1: Upload -->
                            <div id="step1-content">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>Planilha de Vendas</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="upload-area" id="upload-vendas">
                                                    <img src="https://cdn-icons-png.flaticon.com/512/337/337946.png" width="50" height="50" alt="Upload">
                                                    <h4 class="mt-3">Arraste e solte a planilha de vendas aqui</h4>
                                                    <p>ou clique para selecionar o arquivo</p>
                                                    <input type="file" id="file-vendas" style="display: none;" accept=".xlsx,.xls">
                                                </div>
                                                <div id="vendas-file-info" class="mt-3"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>Planilha de Clientes</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="upload-area" id="upload-clientes">
                                                    <img src="https://cdn-icons-png.flaticon.com/512/337/337946.png" width="50" height="50" alt="Upload">
                                                    <h4 class="mt-3">Arraste e solte a planilha de clientes aqui</h4>
                                                    <p>ou clique para selecionar o arquivo</p>
                                                    <input type="file" id="file-clientes" style="display: none;" accept=".xlsx,.xls">
                                                </div>
                                                <div id="clientes-file-info" class="mt-3"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end mt-3">
                                    <button id="next-step1" class="btn btn-primary">Pr√≥ximo</button>
                                </div>
                            </div>

                            <!-- Step 2: Mapeamento -->
                            <div id="step2-content" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>Mapeamento de Colunas - Vendas</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Data</label>
                                                    <select class="form-select" id="map-vendas-data">
                                                        <option value="">Selecione a coluna</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Movimenta√ß√£o</label>
                                                    <select class="form-select" id="map-vendas-movimentacao">
                                                        <option value="">Selecione a coluna</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Quantidade</label>
                                                    <select class="form-select" id="map-vendas-quantidade">
                                                        <option value="">Selecione a coluna</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Total</label>
                                                    <select class="form-select" id="map-vendas-total">
                                                        <option value="">Selecione a coluna</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Cliente</label>
                                                    <select class="form-select" id="map-vendas-cliente">
                                                        <option value="">Selecione a coluna</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Vendedor</label>
                                                    <select class="form-select" id="map-vendas-vendedor">
                                                        <option value="">Selecione a coluna</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Telefone</label>
                                                    <select class="form-select" id="map-vendas-telefone">
                                                        <option value="">Selecione a coluna</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>Mapeamento de Colunas - Clientes</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">ID</label>
                                                    <select class="form-select" id="map-clientes-id">
                                                        <option value="">Selecione a coluna</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Nome</label>
                                                    <select class="form-select" id="map-clientes-nome">
                                                        <option value="">Selecione a coluna</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">CPF</label>
                                                    <select class="form-select" id="map-clientes-cpf">
                                                        <option value="">Selecione a coluna</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Telefone 1</label>
                                                    <select class="form-select" id="map-clientes-telefone1">
                                                        <option value="">Selecione a coluna</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Telefone 2</label>
                                                    <select class="form-select" id="map-clientes-telefone2">
                                                        <option value="">Selecione a coluna</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Telefone 3</label>
                                                    <select class="form-select" id="map-clientes-telefone3">
                                                        <option value="">Selecione a coluna</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Data de Cadastro</label>
                                                    <select class="form-select" id="map-clientes-data-cadastro">
                                                        <option value="">Selecione a coluna</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between mt-3">
                                    <button id="prev-step2" class="btn btn-secondary">Anterior</button>
                                    <button id="next-step2" class="btn btn-primary">Pr√≥ximo</button>
                                </div>
                            </div>

                            <!-- Step 3: Processamento -->
                            <div id="step3-content" style="display: none;">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Processamento de Dados</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-4">
                                            <h6>Progresso</h6>
                                            <div class="progress mb-3">
                                                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                            </div>
                                        </div>
                                        <div class="mb-4">
                                            <h6>Log de Processamento</h6>
                                            <div id="processing-log"></div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-3">
                                            <button id="prev-step3" class="btn btn-secondary">Anterior</button>
                                            <button id="start-processing" class="btn btn-primary">Iniciar Processamento</button>
                                            <button id="next-step3" class="btn btn-success" style="display: none;">Pr√≥ximo</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4: Conclus√£o -->
                            <div id="step4-content" style="display: none;">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" width="80" height="80" alt="Success" class="mb-3">
                                        <h4 class="mb-3">Processamento Conclu√≠do com Sucesso!</h4>
                                        <p>Os dados foram importados e processados. Agora voc√™ pode visualizar as informa√ß√µes no dashboard e na lista de clientes.</p>
                                        <button class="btn btn-primary" onclick="showPage('dashboard')">Ir para o Dashboard</button>
                                        <button id="prev-step4" class="btn btn-secondary">Voltar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Fun√ß√µes de navega√ß√£o e estado da aplica√ß√£o
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            document.getElementById(pageId).style.display = 'block';

            document.querySelectorAll('.sidebar a').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.sidebar a[href="#${pageId}"]`).classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM carregado, inicializando aplica√ß√£o...");
            showPage('dashboard');
            
            // Carregar dados do localStorage se existirem
            const storedData = localStorage.getItem("crm_data");
            if (storedData) {
                console.log("Dados encontrados no localStorage");
                const clientes = JSON.parse(storedData);
                atualizarDashboard(clientes);
                atualizarTabelaClientes(clientes);
            }
            
            // Inicializar os event listeners para upload de arquivos
            inicializarUploadHandlers();
            
            // Inicializar os event listeners para navega√ß√£o entre etapas
            inicializarNavegacaoEtapas();
        });

        // Inicializar os manipuladores de eventos para upload de arquivos
        function inicializarUploadHandlers() {
            console.log("Inicializando manipuladores de upload...");
            
            ['vendas', 'clientes'].forEach(type => {
                const uploadArea = document.getElementById(`upload-${type}`);
                const fileInput = document.getElementById(`file-${type}`);
                const fileInfo = document.getElementById(`${type}-file-info`);
                
                if (!uploadArea || !fileInput || !fileInfo) {
                    console.error(`Elementos de upload para ${type} n√£o encontrados`);
                    return;
                }

                uploadArea.addEventListener('click', () => {
                    console.log(`Clique na √°rea de upload de ${type}`);
                    fileInput.click();
                });

                fileInput.addEventListener('change', () => {
                    console.log(`Arquivo de ${type} selecionado`);
                    if (fileInput.files.length > 0) {
                        fileInfo.innerHTML = `<p><strong>Arquivo selecionado:</strong> ${fileInput.files[0].name}</p>`;
                    }
                });

                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('active');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('active');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('active');
                    fileInput.files = e.dataTransfer.files;
                    if (fileInput.files.length > 0) {
                        fileInfo.innerHTML = `<p><strong>Arquivo selecionado:</strong> ${fileInput.files[0].name}</p>`;
                    }
                });
            });
        }

        // Inicializar os manipuladores de eventos para navega√ß√£o entre etapas
        function inicializarNavegacaoEtapas() {
            console.log("Inicializando navega√ß√£o entre etapas...");
            
            const steps = ["step1-content", "step2-content", "step3-content", "step4-content"];
            let currentStep = 0;

            function showStep(stepIndex) {
                steps.forEach((contentId, index) => {
                    const element = document.getElementById(contentId);
                    if (element) {
                        element.style.display = (index === stepIndex) ? "block" : "none";
                    } else {
                        console.error(`Elemento ${contentId} n√£o encontrado`);
                    }
                });

                const stepIndicators = document.querySelectorAll(".step");
                stepIndicators.forEach((indicator, index) => {
                    if (index === stepIndex) {
                        indicator.classList.add("active");
                    } else {
                        indicator.classList.remove("active");
                    }
                });

                currentStep = stepIndex;
            }

            // Bot√µes de navega√ß√£o entre etapas
            const nextStep1Button = document.getElementById("next-step1");
            if (nextStep1Button) {
                nextStep1Button.addEventListener("click", async () => {
                    const vendasFileInput = document.getElementById("file-vendas");
                    const clientesFileInput = document.getElementById("file-clientes");
                    
                    if (!vendasFileInput.files.length || !clientesFileInput.files.length) {
                        alert("Por favor, selecione os dois arquivos.");
                        return;
                    }
                    
                    showStep(1);

                    try {
                        const vendasHeaders = await getHeaders(vendasFileInput.files[0]);
                        const clientesHeaders = await getHeaders(clientesFileInput.files[0]);

                        populateSelect("map-vendas-data", vendasHeaders);
                        populateSelect("map-vendas-movimentacao", vendasHeaders);
                        populateSelect("map-vendas-quantidade", vendasHeaders);
                        populateSelect("map-vendas-total", vendasHeaders);
                        populateSelect("map-vendas-cliente", vendasHeaders);
                        populateSelect("map-vendas-vendedor", vendasHeaders);
                        populateSelect("map-vendas-telefone", vendasHeaders);

                        populateSelect("map-clientes-id", clientesHeaders);
                        populateSelect("map-clientes-nome", clientesHeaders);
                        populateSelect("map-clientes-cpf", clientesHeaders);
                        populateSelect("map-clientes-telefone1", clientesHeaders);
                        populateSelect("map-clientes-telefone2", clientesHeaders);
                        populateSelect("map-clientes-telefone3", clientesHeaders);
                        populateSelect("map-clientes-data-cadastro", clientesHeaders);

                    } catch (error) {
                        console.error("Erro ao ler os cabe√ßalhos dos arquivos:", error);
                        alert("Ocorreu um erro ao ler os arquivos. Verifique o console para mais detalhes.");
                    }
                });
            }

            const prevStep2Button = document.getElementById("prev-step2");
            if (prevStep2Button) {
                prevStep2Button.addEventListener("click", () => showStep(0));
            }
            
            const nextStep2Button = document.getElementById("next-step2");
            if (nextStep2Button) {
                nextStep2Button.addEventListener("click", () => showStep(2));
            }
            
            const prevStep3Button = document.getElementById("prev-step3");
            if (prevStep3Button) {
                prevStep3Button.addEventListener("click", () => showStep(1));
            }
            
            const nextStep3Button = document.getElementById("next-step3");
            if (nextStep3Button) {
                nextStep3Button.addEventListener("click", () => showStep(3));
            }
            
            const prevStep4Button = document.getElementById("prev-step4");
            if (prevStep4Button) {
                prevStep4Button.addEventListener("click", () => showStep(2));
            }

            // Inicializar na primeira etapa
            showStep(0);
        }

        // L√≥gica de processamento de dados
        const processButton = document.getElementById("start-processing");
        const processingLog = document.getElementById("processing-log");

        function log(message, type = 'info') {
            const logEntry = document.createElement('p');
            logEntry.className = `log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            processingLog.appendChild(logEntry);
            processingLog.scrollTop = processingLog.scrollHeight;
        }

        if (processButton) {
            processButton.addEventListener('click', async () => {
                const vendasFileInput = document.getElementById("file-vendas");
                const clientesFileInput = document.getElementById("file-clientes");
                
                if (!vendasFileInput.files.length || !clientesFileInput.files.length) {
                    log('Por favor, selecione os dois arquivos.', 'error');
                    return;
                }

                log('Iniciando o processamento dos arquivos...');

                try {
                    const vendasData = await readFile(vendasFileInput.files[0]);
                    const pessoasData = await readFile(clientesFileInput.files[0]);

                    log('Arquivos lidos com sucesso. Processando dados...', 'success');

                    const clientes = processarDados(vendasData, pessoasData);

                    log(`Processamento conclu√≠do. ${clientes.length} clientes encontrados.`, 'success');

                    // Salvar no localStorage
                    localStorage.setItem('crm_data', JSON.stringify(clientes));

                    log('Dados salvos no armazenamento local.', 'success');

                    // Atualizar o dashboard
                    atualizarDashboard(clientes);
                    atualizarTabelaClientes(clientes);

                    log('Dashboard e tabelas atualizadas.', 'success');
                    document.getElementById("next-step3").style.display = "block";

                } catch (error) {
                    log(`Ocorreu um erro: ${error.message}`, 'error');
                    console.error(error);
                }
            });
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);
                        resolve(json);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        }

        function getHeaders(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const headers = XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0];
                        resolve(headers);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) {
                console.error(`Elemento select ${selectId} n√£o encontrado`);
                return;
            }
            
            select.innerHTML = '<option value="">Selecione a coluna</option>';
            options.forEach(option => {
                const optionElement = document.createElement("option");
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        function processarDados(vendas, pessoas) {
            const vendasPorCliente = {};

            const clienteField = document.getElementById("map-vendas-cliente").value;
            const dataField = document.getElementById("map-vendas-data").value;
            const nomeField = document.getElementById("map-clientes-nome").value;
            const cpfField = document.getElementById("map-clientes-cpf").value;
            const telefone1Field = document.getElementById("map-clientes-telefone1").value;
            const telefone2Field = document.getElementById("map-clientes-telefone2").value;
            const telefone3Field = document.getElementById("map-clientes-telefone3").value;

            vendas.forEach(venda => {
                const clienteNome = venda[clienteField];
                if (!clienteNome) return;

                if (!vendasPorCliente[clienteNome]) {
                    vendasPorCliente[clienteNome] = [];
                }
                vendasPorCliente[clienteNome].push(venda);
            });

            const clientes = pessoas.map(pessoa => {
                const nome = pessoa[nomeField];
                const vendasCliente = vendasPorCliente[nome] || [];
                const ultimaVenda = vendasCliente.sort((a, b) => {
                    const dateA = new Date(a[dataField]);
                    const dateB = new Date(b[dataField]);
                    return dateB - dateA;
                })[0];

                const ultimaCompra = ultimaVenda ? new Date(ultimaVenda[dataField]) : null;
                const diasInativo = ultimaCompra ? Math.floor((new Date() - ultimaCompra) / (1000 * 60 * 60 * 24)) : null;

                return {
                    nome: nome,
                    cpf: pessoa[cpfField],
                    telefone: pessoa[telefone1Field] || pessoa[telefone2Field] || pessoa[telefone3Field],
                    ultimaCompra: ultimaCompra ? ultimaCompra.toLocaleDateString('pt-BR') : 'N/A',
                    diasInativo: diasInativo,
                    status: getStatus(diasInativo)
                };
            });

            return clientes;
        }

        function getStatus(dias) {
            if (dias === null) return 'Sem compras';
            if (dias <= 30) return 'Ativo (0-30 dias)';
            if (dias <= 60) return 'Ativo (31-60 dias)';
            if (dias <= 90) return 'Em risco (61-90 dias)';
            if (dias <= 180) return 'Em risco elevado (91-180 dias)';
            if (dias <= 365) return 'Inativo (181-365 dias)';
            return 'Perdido (>365 dias)';
        }

        function atualizarDashboard(clientes) {
            const totalClientes = clientes.length;
            const clientesAtivos = clientes.filter(c => c.diasInativo !== null && c.diasInativo <= 60).length;
            const clientesInativos = clientes.filter(c => c.diasInativo !== null && c.diasInativo > 180).length;
            const clientesRisco = clientes.filter(c => c.diasInativo !== null && c.diasInativo > 60 && c.diasInativo <= 180).length;
            const diasMedios = totalClientes > 0 ? Math.floor(clientes.reduce((acc, c) => acc + (c.diasInativo || 0), 0) / totalClientes) : 0;

            document.getElementById('clientes-ativos').textContent = clientesAtivos;
            document.getElementById('clientes-inativos').textContent = clientesInativos;
            document.getElementById('clientes-risco').textContent = clientesRisco;
            document.getElementById('dias-medios').textContent = diasMedios;

            // Atualizar gr√°fico
            const ctx = document.getElementById('inactivityChart');
            if (!ctx) {
                console.error('Elemento canvas inactivityChart n√£o encontrado');
                return;
            }
            
            const chartData = {
                labels: ['0-30', '31-60', '61-90', '91-180', '181-365', '>365'],
                datasets: [{
                    label: 'N¬∫ de Clientes',
                    data: [
                        clientes.filter(c => c.diasInativo !== null && c.diasInativo <= 30).length,
                        clientes.filter(c => c.diasInativo !== null && c.diasInativo > 30 && c.diasInativo <= 60).length,
                        clientes.filter(c => c.diasInativo !== null && c.diasInativo > 60 && c.diasInativo <= 90).length,
                        clientes.filter(c => c.diasInativo !== null && c.diasInativo > 90 && c.diasInativo <= 180).length,
                        clientes.filter(c => c.diasInativo !== null && c.diasInativo > 180 && c.diasInativo <= 365).length,
                        clientes.filter(c => c.diasInativo !== null && c.diasInativo > 365).length,
                    ],
                    backgroundColor: ['#28a745', '#20c997', '#ffc107', '#fd7e14', '#dc3545', '#6c757d']
                }]
            };

            if (window.myChart) {
                window.myChart.destroy();
            }

            window.myChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Atualizar tabela de clientes que precisam de aten√ß√£o
            const clientesAtencao = clientes.filter(c => c.diasInativo !== null && c.diasInativo > 60).sort((a, b) => b.diasInativo - a.diasInativo).slice(0, 5);
            const tbodyAtencao = document.getElementById('clientes-atencao');
            if (!tbodyAtencao) {
                console.error('Elemento tbody clientes-atencao n√£o encontrado');
                return;
            }
            
            tbodyAtencao.innerHTML = '';

            if (clientesAtencao.length > 0) {
                clientesAtencao.forEach(cliente => {
                    const row = `<tr>
                        <td>${cliente.nome}</td>
                        <td>${cliente.ultimaCompra}</td>
                        <td>${cliente.diasInativo}</td>
                        <td><button class="btn btn-sm btn-primary">Ver</button></td>
                    </tr>`;
                    tbodyAtencao.innerHTML += row;
                });
            } else {
                tbodyAtencao.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum cliente precisa de aten√ß√£o no momento.</td></tr>';
            }
        }

        function atualizarTabelaClientes(clientes) {
            const tbody = document.getElementById('lista-clientes');
            if (!tbody) {
                console.error('Elemento tbody lista-clientes n√£o encontrado');
                return;
            }
            
            tbody.innerHTML = '';

            if (clientes.length > 0) {
                clientes.forEach(cliente => {
                    const row = `<tr>
                        <td>${cliente.nome}</td>
                        <td>${cliente.cpf || 'N/A'}</td>
                        <td>${cliente.telefone || 'N/A'}</td>
                        <td>${cliente.ultimaCompra}</td>
                        <td>${cliente.diasInativo === null ? 'N/A' : cliente.diasInativo}</td>
                        <td><span class="badge ${getStatusBadge(cliente.status)}">${cliente.status}</span></td>
                        <td><button class="btn btn-sm btn-primary">Detalhes</button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum dado dispon√≠vel</td></tr>';
            }
        }

        function getStatusBadge(status) {
            if (status.includes('Ativo')) return 'bg-success';
            if (status.includes('risco elevado')) return 'bg-danger';
            if (status.includes('risco')) return 'bg-warning';
            if (status.includes('Inativo')) return 'bg-secondary';
            if (status.includes('Perdido')) return 'bg-dark';
            return 'bg-primary';
        }
    </script>
</body>
</html>
